<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cricket Club Manager</title>
<style>
  /* --- DESIGN SYSTEM --- */
  :root {
    --primary: #1565C0;
    --secondary: #00897B;
    --accent: #FF6F00;
    --text-dark: #263238;
    --text-med: #546E7A;
    --bg-body: #E3F2FD; /* Lighter Blue Background */
    --bg-card: #FFFFFF;
  }

  body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-body); color: var(--text-dark); margin: 0; padding-bottom: 50px; }
  
  /* --- NAVBAR --- */
  .navbar { background: linear-gradient(135deg, var(--primary), #42A5F5); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .navbar h1 { margin: 0; font-size: 1.2rem; }
  .nav-links button { background: none; border: none; color: white; font-size: 1rem; margin-left: 15px; cursor: pointer; opacity: 0.9; }
  .nav-links button:hover { opacity: 1; text-decoration: underline; }

  .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
  .card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
  
  /* --- ELEMENTS --- */
  h2 { color: var(--primary); margin-top: 0; border-bottom: 2px solid #E3F2FD; padding-bottom: 10px; }
  input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #CFD8DC; border-radius: 6px; box-sizing: border-box; }
  .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
  .btn:hover { background: #0D47A1; }
  
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th { background: #E3F2FD; color: var(--primary); padding: 10px; text-align: left; }
  td { padding: 10px; border-bottom: 1px solid #ECEFF1; color: var(--text-med); }

  .marquee { background: var(--secondary); color: white; padding: 10px; overflow: hidden; white-space: nowrap; font-weight: 600; }
  
  /* --- FIX FOR LOADING SCREEN --- */
  .loading-overlay { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(255,255,255,0.95); 
      display: flex; justify-content: center; align-items: center; 
      z-index: 9999; flex-direction: column;
  }
  
  /* IMPORTANT: This forces the loader to hide when we add the class */
  .hidden { display: none !important; }

</style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <h2 style="border:none;">Loading Club Data...</h2>
    <div style="color: #666;">Please wait...</div>
</div>

<div class="navbar">
  <h1>üèè Club Manager</h1>
  <div class="nav-links">
    <button onclick="nav('home')">Home</button>
    <button onclick="nav('rankings')">Rankings</button>
    <button onclick="nav('admin')">Admin</button>
  </div>
</div>

<div class="marquee" id="ticker">Loading announcements...</div>

<div class="container">

  <div id="home" class="view">
    <div class="card" style="text-align: center;">
      <h2 style="border:none;">Next Match Countdown</h2>
      <div id="countdown" style="font-size: 2rem; color: var(--accent); font-weight: bold;">--:--:--</div>
      <p id="next-match-info" style="color: var(--text-med);">Checking schedule...</p>
    </div>

    <div class="card">
      <h2>Recent Matches</h2>
      <table id="match-list-table">
        <thead><tr><th>Date</th><th>Tournament</th><th>Match</th><th>Winner</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="rankings" class="view hidden">
    <div class="card">
      <h2>Player Rankings</h2>
      <div style="display: flex; gap: 10px;">
        <select id="rank-filter-season" onchange="renderRankings()"><option value="All">All Seasons</option></select>
        <select id="rank-filter-tourn" onchange="renderRankings()"><option value="All">All Tournaments</option></select>
      </div>
      <table id="rankings-table">
        <thead><tr><th>Rank</th><th>Player</th><th>Runs</th><th>Wickets</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="admin" class="view hidden">
    <div id="admin-login" class="card">
      <h2>Admin Access</h2>
      <input type="password" id="admin-pass-input" placeholder="Enter Password (9908)">
      <button class="btn" onclick="verifyAdmin()">Login</button>
    </div>

    <div id="admin-dash" class="hidden">
      <div class="card">
        <h2>1. Create Tournament</h2>
        <input type="text" id="t-name" placeholder="Name">
        <input type="text" id="t-season" placeholder="Season (e.g. 2026)">
        <button class="btn" onclick="api('addTournament', {name: val('t-name'), season: val('t-season')})">Create</button>
      </div>

      <div class="card">
        <h2>2. Schedule Match</h2>
        <select id="m-tourn-select"></select>
        <input type="text" id="m-stage" placeholder="Stage (e.g. Final)">
        <input type="date" id="m-date">
        <div style="display:flex; gap:10px">
          <input type="text" id="m-teamA" placeholder="Team A">
          <input type="text" id="m-teamB" placeholder="Team B">
        </div>
        <button class="btn" onclick="addMatch()">Schedule</button>
      </div>

      <div class="card">
        <h2>3. Update Scores</h2>
        <select id="score-match-select" onchange="loadMatchPlayers()"></select>
        <div id="score-entry-area" class="hidden">
           <br><label>Add Player Stats:</label>
           <select id="score-player-select"></select>
           <div style="display:flex; gap:5px">
             <input type="number" id="s-runs" placeholder="Runs">
             <input type="number" id="s-wkt" placeholder="Wkts">
           </div>
           <button class="btn" style="background:#555;" onclick="queueStat()">+ Add Stat</button>
           <div id="stat-queue" style="margin: 10px 0; padding: 10px; background: #eee;"></div>
           <input type="text" id="s-winner" placeholder="Winner Name">
           <button class="btn" onclick="submitMatchStats()">Submit Result</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // YOUR EXACT URL IS ALREADY HERE:
  const API_URL = "https://script.google.com/macros/s/AKfycbz2oMZBNMk5rqWBm1NG8c3f0TruWL_pPhpPrAt0b-kmvFCBZQis8yY0KejlLRbwB7SI/exec";
  
  let DB = {}; 

  window.onload = async () => {
    try {
        console.log("Fetching...");
        const res = await fetch(API_URL + "?action=getAllData");
        const text = await res.text();
        DB = JSON.parse(text);

        // Render Everything
        if(DB.announcements) {
             const anns = DB.announcements.sort((a,b) => b.Priority === "High" ? 1 : -1);
             document.getElementById('ticker').innerText = anns.map(a => a.Message).join("  |  ");
        }

        renderHome();
        renderRankings();
        populateDropdowns();

    } catch(e) {
        alert("Error: " + e.message);
    } finally {
        // FORCE HIDE LOADER
        document.getElementById('loader').style.display = 'none'; 
    }

    setInterval(updateCountdown, 1000);
  };

  // --- RENDERERS ---
  function renderHome() {
    const tbody = document.querySelector('#match-list-table tbody');
    tbody.innerHTML = "";
    if(DB.matches) {
        DB.matches.slice(0, 10).forEach(m => {
           // Safe Date Format
           let d = m.Date;
           if(m.Date && m.Date.includes && m.Date.includes('T')) d = m.Date.split('T')[0];
           
           const tourn = DB.tournaments.find(t => t.ID == m.TournamentID);
           tbody.innerHTML += `<tr>
             <td>${d}</td>
             <td>${tourn ? tourn.Name : 'Unk'}</td>
             <td>${m.TeamA} vs ${m.TeamB}<br><small>${m.Stage}</small></td>
             <td>${m.Winner || "-"}</td>
           </tr>`;
        });
        
        // Countdown
        const future = DB.matches.find(m => new Date(m.Date) > new Date());
        if(future) {
            window.nextMatchDate = new Date(future.Date);
            document.getElementById('next-match-info').innerText = `${future.TeamA} vs ${future.TeamB}`;
        } else {
            document.getElementById('next-match-info').innerText = "No upcoming matches.";
        }
    }
  }

  function updateCountdown() {
    if(!window.nextMatchDate) return;
    const diff = window.nextMatchDate - new Date();
    if(diff < 0) return;
    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    document.getElementById('countdown').innerText = `${d}d ${h}h`;
  }

  function renderRankings() {
    if(!DB.stats) return;
    const sFilter = document.getElementById('rank-filter-season').value;
    const tFilter = document.getElementById('rank-filter-tourn').value;
    let stats = {};

    DB.stats.forEach(s => {
        const m = DB.matches.find(x => x.MatchID == s.MatchID);
        if(!m) return;
        const t = DB.tournaments.find(x => x.ID == m.TournamentID);
        
        if(sFilter !== "All" && t.Season != sFilter) return;
        if(tFilter !== "All" && t.ID != tFilter) return;

        if(!stats[s.PlayerID]) stats[s.PlayerID] = {name: "", runs:0, wkts:0};
        const p = DB.players.find(x => x.ID == s.PlayerID);
        stats[s.PlayerID].name = p ? p.Name : "Unknown";
        stats[s.PlayerID].runs += Number(s.Runs);
        stats[s.PlayerID].wkts += Number(s.Wickets);
    });

    const tbody = document.querySelector('#rankings-table tbody');
    tbody.innerHTML = "";
    Object.values(stats).sort((a,b) => b.runs - a.runs).forEach((p,i) => {
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.runs}</td><td>${p.wkts}</td></tr>`;
    });
  }

  // --- ACTIONS ---
  function nav(id) {
    document.querySelectorAll('.view').forEach(d => d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function val(id) { return document.getElementById(id).value; }

  function verifyAdmin() {
    if(val('admin-pass-input') === "9908") {
       document.getElementById('admin-login').classList.add('hidden');
       document.getElementById('admin-dash').classList.remove('hidden');
    } else { alert("Wrong Password"); }
  }

  function populateDropdowns() {
    const ts = document.getElementById('m-tourn-select');
    const fs = document.getElementById('rank-filter-tourn');
    ts.innerHTML = ""; fs.innerHTML = "<option value='All'>All</option>";
    if(DB.tournaments) {
        DB.tournaments.forEach(t => {
            const opt = `<option value="${t.ID}">${t.Name}</option>`;
            ts.innerHTML += opt; fs.innerHTML += opt;
        });
    }

    const ps = document.getElementById('score-player-select');
    ps.innerHTML = "";
    if(DB.players) DB.players.forEach(p => ps.innerHTML += `<option value="${p.ID}">${p.Name}</option>`);
    
    const ms = document.getElementById('score-match-select');
    ms.innerHTML = "<option>Select Match...</option>";
    if(DB.matches) DB.matches.filter(m => m.Status !== "Completed").forEach(m => 
        ms.innerHTML += `<option value="${m.MatchID}">${m.TeamA} vs ${m.TeamB}</option>`
    );
  }

  let statQueue = [];
  function loadMatchPlayers() {
     document.getElementById('score-entry-area').classList.remove('hidden');
     statQueue = []; 
     document.getElementById('stat-queue').innerHTML = "";
  }

  function queueStat() {
     const ps = document.getElementById('score-player-select');
     const name = ps.options[ps.selectedIndex].text;
     const stat = {id: ps.value, runs: val('s-runs'), wickets: val('s-wkt'), overs:0, catches:0};
     statQueue.push(stat);
     document.getElementById('stat-queue').innerHTML += `<div>${name}: ${stat.runs}R, ${stat.wickets}W</div>`;
  }

  function addMatch() {
    api('addMatch', { tournId: val('m-tourn-select'), stage: val('m-stage'), date: val('m-date'), teamA: val('m-teamA'), teamB: val('m-teamB') });
  }

  function submitMatchStats() {
     api('updateMatchStats', { matchId: val('score-match-select'), winner: val('s-winner'), playerStats: statQueue });
  }

  function api(action, payload) {
     payload.action = action;
     payload.password = "9908";
     document.getElementById('loader').style.display = 'flex'; // Show loader
     fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
     .then(() => { alert("Saved!"); location.reload(); });
  }
</script>
</body>
</html>
