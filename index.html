<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cricket Club Manager</title>
<style>
  /* --- DESIGN SYSTEM: NO BLACK --- */
  :root {
    --primary: #1565C0; /* Deep Blue */
    --secondary: #00897B; /* Teal */
    --accent: #FF6F00; /* Amber */
    --text-dark: #263238; /* Blue Grey (Not Black) */
    --text-med: #546E7A;
    --bg-body: #F5F7FA;
    --bg-card: #FFFFFF;
    --border: #CFD8DC;
  }

  body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-body); color: var(--text-dark); margin: 0; padding-bottom: 50px; }
  
  /* --- COMPONENTS --- */
  .navbar { background: linear-gradient(135deg, var(--primary), #42A5F5); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .navbar h1 { margin: 0; font-size: 1.2rem; }
  .nav-links button { background: none; border: none; color: white; font-size: 1rem; margin-left: 15px; cursor: pointer; opacity: 0.9; }
  .nav-links button:hover { opacity: 1; text-decoration: underline; }

  .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }

  .card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
  
  h2 { color: var(--primary); margin-top: 0; border-bottom: 2px solid #E3F2FD; padding-bottom: 10px; }

  /* --- FORMS --- */
  input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 6px; background: #FAFAFA; color: var(--text-dark); box-sizing: border-box; }
  input:focus, select:focus { border-color: var(--primary); outline: none; }
  
  .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
  .btn:hover { background: #0D47A1; }
  .btn-accent { background: var(--accent); }

  /* --- TABLES --- */
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th { background: #E3F2FD; color: var(--primary); padding: 10px; text-align: left; font-weight: 600; }
  td { padding: 10px; border-bottom: 1px solid #ECEFF1; color: var(--text-med); }

  /* --- TICKER --- */
  .marquee { background: var(--secondary); color: white; padding: 10px; overflow: hidden; white-space: nowrap; font-weight: 600; }
  
  /* --- LOADING/HIDDEN --- */
  .hidden { display: none; }
  .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
</style>
</head>
<body>

<div id="loader" class="loading-overlay"><div>Loading Data...</div></div>

<div class="navbar">
  <h1>üèè Club Manager</h1>
  <div class="nav-links">
    <button onclick="nav('home')">Home</button>
    <button onclick="nav('rankings')">Rankings</button>
    <button onclick="nav('admin')">Admin</button>
  </div>
</div>

<div class="marquee" id="ticker">Waiting for announcements...</div>

<div class="container">

  <div id="home" class="view">
    <div class="card" style="text-align: center;">
      <h2 style="border:none;">Next Match Countdown</h2>
      <div id="countdown" style="font-size: 2rem; color: var(--accent); font-weight: bold;">--:--:--</div>
      <p id="next-match-info" style="color: var(--text-med);">Loading schedule...</p>
    </div>

    <div class="card">
      <h2>Recent Matches</h2>
      <table id="match-list-table">
        <thead><tr><th>Date</th><th>Tournament</th><th>Match</th><th>Winner</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="rankings" class="view hidden">
    <div class="card">
      <h2>Player Rankings</h2>
      <div style="display: flex; gap: 10px;">
        <select id="rank-filter-season" onchange="renderRankings()"><option value="All">All Seasons</option></select>
        <select id="rank-filter-tourn" onchange="renderRankings()"><option value="All">All Tournaments</option></select>
      </div>
      <table id="rankings-table">
        <thead><tr><th>Rank</th><th>Player</th><th>Runs</th><th>Wickets</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="admin" class="view hidden">
    
    <div id="admin-login" class="card">
      <h2>Admin Access</h2>
      <input type="password" id="admin-pass-input" placeholder="Enter Password (9908)">
      <button class="btn" onclick="verifyAdmin()">Login</button>
    </div>

    <div id="admin-dash" class="hidden">
      
      <div class="card">
        <h2>1. Create Tournament</h2>
        <input type="text" id="t-name" placeholder="Tournament Name (e.g. Winter Cup)">
        <input type="text" id="t-season" placeholder="Season Year (e.g. 2026)">
        <button class="btn" onclick="api('addTournament', {name: val('t-name'), season: val('t-season')})">Create Tournament</button>
      </div>

      <div class="card">
        <h2>2. Schedule Match</h2>
        <label>Select Tournament:</label>
        <select id="m-tourn-select"></select>
        <input type="text" id="m-stage" placeholder="Custom Stage Name (e.g. Semi Final 1)">
        <input type="date" id="m-date">
        <div style="display:flex; gap:10px">
          <input type="text" id="m-teamA" placeholder="Team A Name">
          <input type="text" id="m-teamB" placeholder="Team B Name">
        </div>
        <button class="btn" onclick="addMatch()">Schedule Match</button>
      </div>

      <div class="card">
        <h2>3. Update Scores</h2>
        <label>Select Scheduled Match:</label>
        <select id="score-match-select" onchange="loadMatchPlayers()"></select>
        
        <div id="score-entry-area" class="hidden">
           <h4>Enter Stats</h4>
           <p>Select Player and enter stats. Click 'Add' to queue, then 'Submit All' to save.</p>
           <select id="score-player-select"></select>
           <div style="display:flex; gap:5px">
             <input type="number" id="s-runs" placeholder="Runs">
             <input type="number" id="s-wkt" placeholder="Wickets">
             <input type="number" id="s-ovr" placeholder="Overs">
           </div>
           <button class="btn btn-accent" onclick="queueStat()">+ Add Player Stat</button>
           
           <div id="stat-queue" style="margin: 10px 0; padding: 10px; background: #eee;"></div>
           
           <input type="text" id="s-winner" placeholder="Winning Team Name">
           <button class="btn" onclick="submitMatchStats()">Submit Final Result</button>
        </div>
      </div>
      
    </div>
  </div>

</div>

<script>
  // --- CONFIG ---
  const API_URL = "https://script.google.com/macros/s/AKfycbzHfOoRMRknuwKpOKcCWuupx3IyjLUKF-ER2BJoKD1gey_3fm5zDNUlMTQj-VHuAjA_/exec"; // <--- PASTE DEPLOYED URL HERE
  let DB = {}; // Holds all data locally
  let statQueue = [];

  // --- INIT ---
  window.onload = async () => {
    await loadData();
    setInterval(updateCountdown, 1000);
  };

  // async function loadData() {
  //   document.getElementById('loader').classList.remove('hidden');
  //   try {
  //     const res = await fetch(API_URL + "?action=getAllData");
  //     DB = await res.json();
  //     console.log("DB Loaded:", DB);
      
  //     renderHome();
  //     renderRankings();
  //     populateDropdowns();
      
  //   } catch(e) { alert("Error loading data"); }
  //   document.getElementById('loader').classList.add('hidden');
  // }

  async function loadData() {
      document.getElementById('loader').classList.remove('hidden');
      try {
        console.log("Attempting to fetch from:", API_URL + "?action=getAllData");
        const res = await fetch(API_URL + "?action=getAllData");
        
        // Check if the response is actually JSON
        const text = await res.text(); 
        console.log("Server response:", text);
  
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            alert("Error: Script returned HTML instead of JSON. Check your Permissions (Must be 'Anyone') and Sheet Tab Names.");
            console.error("Parse Error", e);
            return;
        }
  
        if(data.status === "error") {
            alert("Script Error: " + data.message);
            return;
        }
  
        DB = data; // Success
        renderHome();
        renderRankings();
        populateDropdowns();
        
      } catch(e) { 
          alert("Network Error: " + e.message + "\n\nDid you Deploy as 'Anyone'?");
      }
      document.getElementById('loader').classList.add('hidden');
    }

  // --- NAVIGATION ---
  function nav(id) {
    document.querySelectorAll('.view').forEach(d => d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function val(id) { return document.getElementById(id).value; }

  // --- HOME LOGIC ---
  function renderHome() {
    // 1. Ticker
    const anns = DB.announcements.sort((a,b) => b.Priority === "High" ? 1 : -1);
    document.getElementById('ticker').innerText = anns.map(a => a.Message).join("  |  ");

    // 2. Matches Table
    const tbody = document.querySelector('#match-list-table tbody');
    tbody.innerHTML = "";
    DB.matches.slice(0, 10).forEach(m => {
       // Find Tournament Name
       const tourn = DB.tournaments.find(t => t.ID == m.TournamentID);
       const tName = tourn ? tourn.Name : "Unknown";
       
       tbody.innerHTML += `<tr>
         <td>${new Date(m.Date).toLocaleDateString()}</td>
         <td>${tName}</td>
         <td>${m.TeamA} vs ${m.TeamB} <br><small>${m.Stage}</small></td>
         <td>${m.Winner || "-"}</td>
       </tr>`;
    });

    // 3. Countdown (Find first future match)
    const futureMatch = DB.matches.find(m => new Date(m.Date) > new Date());
    if(futureMatch) {
       window.nextMatchDate = new Date(futureMatch.Date);
       document.getElementById('next-match-info').innerText = `${futureMatch.TeamA} vs ${futureMatch.TeamB} (${futureMatch.Stage})`;
    } else {
       document.getElementById('next-match-info').innerText = "No upcoming matches scheduled.";
    }
  }

  function updateCountdown() {
    if(!window.nextMatchDate) return;
    const now = new Date();
    const diff = window.nextMatchDate - now;
    if(diff < 0) return;
    
    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    document.getElementById('countdown').innerText = `${d}d ${h}h`;
  }

  // --- RANKING LOGIC (The Filter Engine) ---
  function renderRankings() {
    const sFilter = val('rank-filter-season');
    const tFilter = val('rank-filter-tourn');
    
    // 1. Calculate Aggregates
    let playerStats = {}; // { PlayerID: { runs: 0, wickets: 0, name: "" } }

    DB.stats.forEach(stat => {
        // Find Match to check filters
        const match = DB.matches.find(m => m.MatchID == stat.MatchID);
        if(!match) return;
        const tourn = DB.tournaments.find(t => t.ID == match.TournamentID);
        if(!tourn) return;

        // Apply Filters
        if (sFilter !== "All" && tourn.Season != sFilter) return;
        if (tFilter !== "All" && tourn.ID != tFilter) return;

        // Aggregation
        if (!playerStats[stat.PlayerID]) {
            const pInfo = DB.players.find(p => p.ID == stat.PlayerID);
            playerStats[stat.PlayerID] = { name: pInfo ? pInfo.Name : "Unknown", runs: 0, wickets: 0 };
        }
        playerStats[stat.PlayerID].runs += Number(stat.Runs);
        playerStats[stat.PlayerID].wickets += Number(stat.Wickets);
    });

    // 2. Render Table
    const tbody = document.querySelector('#rankings-table tbody');
    tbody.innerHTML = "";
    Object.values(playerStats)
      .sort((a,b) => b.runs - a.runs) // Sort by Runs by default
      .forEach((p, i) => {
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.runs}</td><td>${p.wickets}</td></tr>`;
      });
  }

  // --- ADMIN LOGIC ---
  function verifyAdmin() {
    if(val('admin-pass-input') === "9908") {
       document.getElementById('admin-login').classList.add('hidden');
       document.getElementById('admin-dash').classList.remove('hidden');
    } else { alert("Wrong Password"); }
  }

  function populateDropdowns() {
    // Populate Tournament Selects
    const tSelect = document.getElementById('m-tourn-select');
    const fSelect = document.getElementById('rank-filter-tourn');
    tSelect.innerHTML = ""; fSelect.innerHTML = "<option value='All'>All Tournaments</option>";
    
    DB.tournaments.forEach(t => {
      let opt = `<option value="${t.ID}">${t.Name} (${t.Season})</option>`;
      tSelect.innerHTML += opt;
      fSelect.innerHTML += opt;
    });

    // Populate Match Select for Scoring
    const mSelect = document.getElementById('score-match-select');
    mSelect.innerHTML = "<option>Select Match...</option>";
    DB.matches.filter(m => m.Status !== "Completed").forEach(m => {
       mSelect.innerHTML += `<option value="${m.MatchID}">${m.TeamA} vs ${m.TeamB} (${m.Stage})</option>`;
    });
    
    // Populate Players
    const pSelect = document.getElementById('score-player-select');
    pSelect.innerHTML = "";
    DB.players.forEach(p => {
       pSelect.innerHTML += `<option value="${p.ID}">${p.Name}</option>`;
    });
  }

  function addMatch() {
    api('addMatch', {
       tournId: val('m-tourn-select'),
       stage: val('m-stage'),
       date: val('m-date'),
       teamA: val('m-teamA'),
       teamB: val('m-teamB'),
       password: "9908"
    });
  }

  function loadMatchPlayers() {
     document.getElementById('score-entry-area').classList.remove('hidden');
     statQueue = []; // clear queue
     document.getElementById('stat-queue').innerHTML = "";
  }

  function queueStat() {
     const pId = val('score-player-select');
     const pName = document.getElementById('score-player-select').options[document.getElementById('score-player-select').selectedIndex].text;
     
     const stat = {
        id: pId,
        runs: val('s-runs') || 0,
        wickets: val('s-wkt') || 0,
        overs: val('s-ovr') || 0,
        catches: 0
     };
     statQueue.push(stat);
     document.getElementById('stat-queue').innerHTML += `<div>${pName}: ${stat.runs} runs, ${stat.wickets} wkts</div>`;
  }

  function submitMatchStats() {
     api('updateMatchStats', {
        matchId: val('score-match-select'),
        winner: val('s-winner'),
        playerStats: statQueue,
        password: "9908"
     });
  }

  // --- API HELPER ---
  function api(action, payload) {
     payload.action = action;
     payload.password = "9908"; // Auto-include for admin actions
     
     document.getElementById('loader').classList.remove('hidden');
     
     fetch(API_URL, {
       method: 'POST',
       mode: 'no-cors',
       body: JSON.stringify(payload)
     }).then(() => {
       alert("Success! Refreshing...");
       location.reload(); 
     });
  }
</script>
</body>
</html>
