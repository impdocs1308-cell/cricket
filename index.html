<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Royal Cricket Club</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  /* --- LUXURY THEME --- */
  :root {
    --gold: #d4af37;
    --gold-dim: #c5a028;
    --navy: #0a192f;
    --navy-light: #112240;
    --white: #e6f1ff;
    --glass: rgba(17, 34, 64, 0.85);
    --shadow: 0 10px 30px -10px rgba(2,12,27,0.7);
    --anim-speed: 0.3s;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at top, #1b2d45, #0a192f);
    color: var(--white);
    margin: 0; padding-bottom: 80px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--gold); margin-top: 0; }
  
  /* --- ANIMATIONS --- */
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
  
  .view { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
  .hidden { display: none !important; }

  /* --- UI COMPONENTS --- */
  .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
  
  .card {
    background: var(--navy-light);
    border: 1px solid rgba(212, 175, 55, 0.1);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    transition: transform 0.3s;
    backdrop-filter: blur(10px);
  }
  .card:hover { transform: translateY(-5px); border-color: var(--gold); }

  /* Buttons */
  .btn {
    background: linear-gradient(135deg, var(--gold), var(--gold-dim));
    color: var(--navy);
    border: none; padding: 12px 24px;
    border-radius: 50px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    cursor: pointer; width: 100%; margin-top: 15px;
    box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .btn:active { transform: scale(0.98); }
  
  /* Inputs */
  input, select {
    width: 100%; padding: 14px; margin: 8px 0;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--white); border-radius: 8px;
    box-sizing: border-box; font-family: 'Poppins', sans-serif;
  }
  input:focus, select:focus { border-color: var(--gold); outline: none; background: rgba(255,255,255,0.1); }
  option { background: var(--navy); color: var(--white); }

  /* Tables */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th { text-align: left; padding: 15px; color: var(--gold); border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; text-transform: uppercase; }
  td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; }
  tr:hover td { background: rgba(212, 175, 55, 0.05); cursor: pointer; }

  /* --- HEADER & NAV --- */
  header {
    background: rgba(10, 25, 47, 0.95);
    position: sticky; top: 0; z-index: 1000;
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    backdrop-filter: blur(20px);
  }
  .nav-top {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; max-width: 1100px; margin: 0 auto;
  }
  .nav-scroll {
    display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px;
    max-width: 1100px; margin: 0 auto; scrollbar-width: none;
  }
  .nav-btn {
    background: transparent; border: 1px solid rgba(255,255,255,0.2);
    color: var(--white); padding: 8px 20px; border-radius: 30px;
    cursor: pointer; white-space: nowrap; transition: 0.3s;
    font-size: 0.85rem;
  }
  .nav-btn.active { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: bold; }

  /* --- TICKER --- */
  .ticker-wrap {
    background: linear-gradient(90deg, #000, var(--navy));
    color: var(--gold); padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    overflow: hidden; white-space: nowrap; position: relative;
  }
  .ticker-content { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; font-weight: 600; letter-spacing: 1px; }
  @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

  /* --- MODAL --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    display: flex; justify-content: center; align-items: center; z-index: 2000;
    backdrop-filter: blur(5px);
  }
  .modal-box {
    background: var(--navy); width: 90%; max-width: 500px;
    padding: 30px; border-radius: 20px; border: 1px solid var(--gold);
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
    max-height: 85vh; overflow-y: auto;
  }
  .close-btn { float: right; color: var(--gold); font-size: 1.5rem; cursor: pointer; }

  /* --- LOADER --- */
  #loader {
    position: fixed; inset: 0; background: var(--navy); z-index: 9999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .luxury-spinner {
    width: 60px; height: 60px; border: 2px solid rgba(212, 175, 55, 0.3);
    border-top: 2px solid var(--gold); border-radius: 50%;
    animation: spin 1s infinite linear;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* --- COUNTDOWN --- */
  .countdown-box {
    text-align: center; padding: 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
    border-radius: 12px; margin-bottom: 15px;
  }
  .timer { font-size: 2.5rem; font-family: 'Playfair Display', serif; color: var(--gold); font-weight: bold; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
</style>
</head>
<body>

<div id="loader">
  <div class="luxury-spinner"></div>
  <p style="margin-top: 20px; letter-spacing: 2px; font-size: 0.8rem; color: var(--gold);">INITIALIZING EXPERIENCE</p>
</div>

<div id="match-modal" class="modal-overlay hidden">
  <div class="modal-box view">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2 id="m-modal-title" style="border-bottom: 1px solid var(--gold-dim); padding-bottom: 10px;"></h2>
    <p id="m-modal-info" style="color: var(--white); opacity: 0.7;"></p>
    <div style="background: rgba(212,175,55,0.1); padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0;">
      <span id="m-modal-winner" style="color: var(--gold); font-weight: bold; font-size: 1.1rem;"></span>
    </div>
    <h3 style="font-size: 1rem; margin-top: 20px;">Player Performance</h3>
    <table id="m-modal-stats">
      <thead><tr><th>Player</th><th>Team (In Match)</th><th>R</th><th>W</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<header>
  <div class="nav-top">
    <h1>üèè ROYAL CLUB</h1>
    <div onclick="nav('login')" style="cursor: pointer; font-size: 0.8rem; letter-spacing: 1px; color: var(--gold);">üîí MEMBER ACCESS</div>
  </div>
  <div class="nav-scroll">
    <button class="nav-btn active" onclick="nav('home')" id="btn-home">HOME</button>
    <button class="nav-btn" onclick="nav('rankings')" id="btn-rankings">PLAYERS</button>
    <button class="nav-btn" onclick="nav('teams')" id="btn-teams">TEAMS</button>
    <button class="nav-btn hidden" onclick="nav('admin')" id="btn-admin">COMMAND CENTER</button>
    <button class="nav-btn hidden" onclick="nav('profile')" id="btn-profile">MY PROFILE</button>
  </div>
</header>

<div class="ticker-wrap">
  <div class="ticker-content" id="ticker-text">Loading Latest Club Announcements...</div>
</div>

<div class="container">

  <div id="home" class="view">
    <div class="card">
      <h3 style="text-align: center; color: var(--white); opacity: 0.8;">NEXT ENCOUNTER</h3>
      <div class="countdown-box">
        <div class="timer" id="countdown">-- : -- : --</div>
        <div id="next-match-vs" style="margin-top: 10px; font-size: 1.1rem;">Loading Schedule...</div>
      </div>
    </div>

    <div class="card">
      <h2>Match History</h2>
      <table id="match-table">
        <thead><tr><th>Date</th><th>Fixture</th><th>Result</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="rankings" class="view hidden">
    <div class="card">
      <h2>Top Performers</h2>
      <div style="display: flex; gap: 10px;">
        <select id="f-seas" onchange="renderRankings()"><option value="All">All Seasons</option></select>
        <select id="f-tourn" onchange="renderRankings()"><option value="All">All Tournaments</option></select>
      </div>
      <table id="p-rank-table">
        <thead><tr><th>#</th><th>Name</th><th>Runs</th><th>Wkts</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="teams" class="view hidden">
    <div class="card">
      <h2>Team Rankings</h2>
      <table id="t-rank-table">
        <thead><tr><th>Team</th><th>Mat</th><th>Won</th><th>Lost</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="login" class="view hidden">
    <div class="card" style="max-width: 400px; margin: 40px auto; text-align: center;">
      <h2>Secure Entry</h2>
      <select id="login-role" onchange="toggleLogin()" style="margin-bottom: 20px;">
        <option value="admin">Admin</option>
        <option value="player">Player</option>
      </select>
      
      <div id="admin-login-box">
        <input type="password" id="admin-pass" placeholder="Enter Access Code">
        <button class="btn" onclick="doAdminLogin()">Unlock Admin</button>
      </div>
      
      <div id="player-login-box" class="hidden">
        <select id="login-pid"></select>
        <input type="password" id="player-pass" placeholder="Player Password">
        <button class="btn" onclick="doPlayerLogin()">Access Profile</button>
      </div>
    </div>
  </div>

  <div id="admin" class="view hidden">
    <div class="card">
      <h3>üì¢ Announcements</h3>
      <input type="text" id="ann-msg" placeholder="Broadcast Message">
      <select id="ann-prio"><option value="High">Priority: High</option><option value="Low">Priority: Low</option></select>
      <button class="btn" onclick="api('addAnnouncement', {id: Date.now(), message: val('ann-msg'), priority: val('ann-prio'), date: new Date()})">Publish</button>
      <div id="adm-ann-list" style="margin-top: 15px;"></div>
    </div>

    <div class="card">
      <h3>üë§ Roster Management</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="text" id="p-name" placeholder="Full Name">
        <input type="password" id="p-pass" placeholder="Password">
      </div>
      <small style="color: #aaa;">*Team is assigned per match</small>
      <button class="btn" onclick="api('addPlayer', {id: 'P'+Date.now(), name: val('p-name'), role: 'All-Rounder', password: val('p-pass'), team: 'Free Agent'})">Register Player</button>
      <div id="adm-player-list" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="card">
      <h3>üìÖ Schedule Fixture</h3>
      <select id="adm-tourn"></select>
      <input type="text" id="m-stage" placeholder="Stage Name (e.g. Qualifier 1)">
      <input type="date" id="m-date">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="text" id="m-teamA" placeholder="Team A Name">
        <input type="text" id="m-teamB" placeholder="Team B Name">
      </div>
      <button class="btn" onclick="api('addMatch', {id: 'M'+Date.now(), tournId: val('adm-tourn'), stage: val('m-stage'), date: val('m-date'), teamA: val('m-teamA'), teamB: val('m-teamB')})">Create Fixture</button>
    </div>

    <div class="card">
      <h3>üìù Match Scoring</h3>
      <select id="score-match" onchange="enableScoring()"></select>
      
      <div id="score-box" class="hidden">
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
           <label style="color: var(--gold); font-size: 0.9rem;">1. Select Player & Team</label>
           <select id="score-player"></select>
           
           <label style="color: var(--gold); font-size: 0.9rem;">2. Which Team did they play for?</label>
           <select id="score-team-select">
             <option value="">Select Team...</option>
             </select>

           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
             <input type="number" id="s-runs" placeholder="Runs">
             <input type="number" id="s-wkt" placeholder="Wickets">
             <input type="number" id="s-ovr" placeholder="Overs">
           </div>
           <button class="btn" style="background: var(--navy); border: 1px solid var(--gold);" onclick="queueStat()">+ Add Player Stat</button>
        </div>

        <div id="stat-queue" style="margin: 15px 0; font-size: 0.9rem; color: var(--gold);"></div>
        
        <input type="text" id="s-winner" placeholder="Winning Team Name">
        <button class="btn" onclick="submitResult()">Finalize Match Result</button>
      </div>
    </div>
  </div>

  <div id="profile" class="view hidden">
    <div class="card" style="text-align: center;">
      <h2 id="prof-name" style="font-size: 2rem;"></h2>
      <p style="color: var(--gold);">Career Statistics</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
          <div style="font-size: 2rem; font-weight: bold; color: var(--white);" id="prof-runs">0</div>
          <div style="font-size: 0.8rem; letter-spacing: 1px;">TOTAL RUNS</div>
        </div>
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
          <div style="font-size: 2rem; font-weight: bold; color: var(--white);" id="prof-wkts">0</div>
          <div style="font-size: 0.8rem; letter-spacing: 1px;">TOTAL WICKETS</div>
        </div>
      </div>

      <h3 style="margin-top: 30px; text-align: left;">Match Log</h3>
      <table id="prof-history">
        <thead><tr><th>Date</th><th>Played For</th><th>vs</th><th>Perf</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
// --- CONFIGURATION ---
// IMPORTANT: Update this URL if you redeployed your Google Script
const API_URL = "https://script.google.com/macros/s/AKfycbwVPV_BiScvuiWgvOjepsfZTRkfFmZKUwVc8UGv4VEetiOHNDv8P9qjKqD8XLnl0gvT/exec"; 

let DB = {};
let statQueue = [];
let currentUser = null;

// --- INIT ---
window.onload = async () => {
  await loadData();
  setInterval(updateCountdown, 1000);
};

// --- CORE DATA ---
async function loadData() {
  document.getElementById('loader').classList.remove('hidden');
  try {
    const res = await fetch(API_URL + "?action=getAllData");
    DB = await res.json();
    refreshUI();
  } catch(e) { console.error(e); alert("Server Connection Failed. Please reload."); }
  document.getElementById('loader').classList.add('hidden');
}

function refreshUI() {
  if(DB.announcements) {
    const text = DB.announcements.map(a => `‚òÖ ${a.Message}`).join("   ");
    document.getElementById('ticker-text').innerText = text;
  }
  
  renderHome();
  renderRankings();
  renderTeams();
  populateDropdowns();
  
  // Refresh Lists if Admin
  if(!document.getElementById('admin').classList.contains('hidden')) renderAdminLists();
}

// --- RENDERERS ---
function renderHome() {
  const tbody = document.querySelector('#match-table tbody');
  tbody.innerHTML = "";
  
  const sorted = [...DB.matches].sort((a,b) => new Date(b.Date) - new Date(a.Date));
  
  sorted.forEach(m => {
    const t = DB.tournaments.find(x => x.ID == m.TournamentID);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(m.Date).toLocaleDateString()}</td>
      <td>
        <div style="font-weight:bold; color:var(--white);">${m.TeamA} <span style="color:var(--gold)">vs</span> ${m.TeamB}</div>
        <div style="font-size:0.8rem; opacity:0.7;">${t ? t.Name : ''} | ${m.Stage}</div>
      </td>
      <td>${m.Winner ? `<span style="color:var(--gold)">${m.Winner} Won</span>` : "Upcoming"}</td>
    `;
    tr.onclick = () => openMatchModal(m);
    tbody.appendChild(tr);
  });

  // Countdown
  const future = DB.matches.filter(m => new Date(m.Date) > new Date()).sort((a,b) => new Date(a.Date) - new Date(b.Date))[0];
  if(future) {
    window.nextEvent = new Date(future.Date);
    document.getElementById('next-match-vs').innerHTML = `${future.TeamA} <span style="color:var(--gold)">VS</span> ${future.TeamB}`;
  } else {
    document.getElementById('next-match-vs').innerText = "No Scheduled Matches";
    document.getElementById('countdown').innerText = "-- : --";
  }
}

function updateCountdown() {
  if(!window.nextEvent) return;
  const diff = window.nextEvent - new Date();
  if(diff <= 0) { document.getElementById('countdown').innerText="LIVE"; return; }
  
  const d = Math.floor(diff / (1000 * 60 * 60 * 24));
  const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  document.getElementById('countdown').innerText = `${d}d : ${h}h : ${m}m`;
}

function renderRankings() {
  const sFilter = val('f-seas');
  const tFilter = val('f-tourn');
  let stats = {};

  DB.stats.forEach(s => {
    const m = DB.matches.find(x => x.MatchID == s.MatchID);
    if(!m) return;
    const t = DB.tournaments.find(x => x.ID == m.TournamentID);
    
    if(sFilter !== "All" && t.Season != sFilter) return;
    if(tFilter !== "All" && t.ID != tFilter) return;

    if(!stats[s.PlayerID]) stats[s.PlayerID] = {name: "", runs: 0, wkts: 0};
    const p = DB.players.find(x => x.ID == s.PlayerID);
    stats[s.PlayerID].name = p ? p.Name : "Unknown";
    stats[s.PlayerID].runs += Number(s.Runs);
    stats[s.PlayerID].wkts += Number(s.Wickets);
  });

  const tbody = document.querySelector('#p-rank-table tbody');
  tbody.innerHTML = "";
  Object.values(stats).sort((a,b) => b.runs - a.runs).forEach((p,i) => {
    tbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.runs}</td><td>${p.wkts}</td></tr>`;
  });
}

function renderTeams() {
   let teams = {};
   DB.matches.filter(m => m.Status === "Completed").forEach(m => {
      [m.TeamA, m.TeamB].forEach(tm => {
         if(!teams[tm]) teams[tm] = {mat:0, won:0, lost:0};
         teams[tm].mat++;
         if(m.Winner === tm) teams[tm].won++; else teams[tm].lost++;
      });
   });
   const tbody = document.querySelector('#t-rank-table tbody');
   tbody.innerHTML = "";
   Object.keys(teams).sort((a,b) => teams[b].won - teams[a].won).forEach(tm => {
      tbody.innerHTML += `<tr><td>${tm}</td><td>${teams[tm].mat}</td><td>${teams[tm].won}</td><td>${teams[tm].lost}</td></tr>`;
   });
}

// --- MATCH MODAL ---
function openMatchModal(m) {
  const t = DB.tournaments.find(x => x.ID == m.TournamentID);
  document.getElementById('m-modal-title').innerText = `${m.TeamA} vs ${m.TeamB}`;
  document.getElementById('m-modal-info').innerText = `${t ? t.Name : ''} - ${new Date(m.Date).toLocaleDateString()}`;
  document.getElementById('m-modal-winner').innerText = m.Winner ? `WINNER: ${m.Winner}` : "MATCH PENDING";
  
  const tbody = document.querySelector('#m-modal-stats tbody');
  tbody.innerHTML = "";
  
  // Filter stats for this match
  const matchStats = DB.stats.filter(s => s.MatchID == m.MatchID);
  
  if(matchStats.length === 0) {
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No stats recorded yet.</td></tr>";
  } else {
    matchStats.forEach(s => {
       const p = DB.players.find(x => x.ID == s.PlayerID);
       // Show Team Name from Stat (The specific team they played for in this match)
       // If undefined (old data), fallback to player default or "-"
       let teamName = s.Team || (p ? p.Team : "-"); 
       // Note: To support "Team" column in stats, backend must save it. 
       // In frontend we rely on what we saved.
       
       // IF the sheet doesn't have a "Team" column in Stats yet, we might need to rely on the Player List default
       // But user asked for "Any team", so we assume backend now sends it.
       // Since the "old" getData might not have named keys if we didn't update headers, 
       // let's assume index 7 is Team if we added it, or use logic.
       
       tbody.innerHTML += `<tr>
         <td>${p ? p.Name : 'Unknown'}</td>
         <td>${teamName}</td>
         <td>${s.Runs}</td>
         <td>${s.Wickets}</td>
       </tr>`;
    });
  }
  document.getElementById('match-modal').classList.remove('hidden');
}
function closeModal() { document.getElementById('match-modal').classList.add('hidden'); }

// --- ADMIN & LOGIC ---
function api(action, payload) {
  // Optimistic UI for smoothness
  payload.action = action;
  payload.password = "9908";
  
  document.getElementById('loader').classList.remove('hidden');
  fetch(API_URL, {
    method: 'POST', mode: 'no-cors', body: JSON.stringify(payload)
  }).then(() => {
     setTimeout(() => { 
       loadData(); // Background Refresh
       // If adding match, re-enable scoring dropdowns
       if(action === 'addMatch') alert("Fixture Created");
     }, 1500);
  });
}

function enableScoring() {
  const mid = val('score-match');
  const match = DB.matches.find(m => m.MatchID == mid);
  const teamSelect = document.getElementById('score-team-select');
  
  if(match) {
    // Populate Team Select with ONLY the two teams playing
    teamSelect.innerHTML = `<option value="${match.TeamA}">${match.TeamA}</option>
                            <option value="${match.TeamB}">${match.TeamB}</option>`;
    
    document.getElementById('score-box').classList.remove('hidden');
    statQueue = []; document.getElementById('stat-queue').innerHTML = "";
  }
}

function queueStat() {
  const pid = val('score-player');
  const teamName = val('score-team-select'); // CRITICAL: Get Selected Team
  const name = document.getElementById('score-player').options[document.getElementById('score-player').selectedIndex].text;
  
  if(!teamName) { alert("Please select which team the player played for!"); return; }

  const item = {
    linkId: "L"+Date.now(),
    matchId: val('score-match'),
    playerId: pid,
    runs: val('s-runs')||0,
    wickets: val('s-wkt')||0,
    overs: val('s-ovr')||0,
    catches: 0,
    teamName: teamName // Send to backend
  };
  
  statQueue.push(item);
  document.getElementById('stat-queue').innerHTML += `<div>+ ${name} (${teamName}): ${item.runs}R, ${item.wickets}W</div>`;
  
  // Send Immediately
  api('addStat', item); 
}

function submitResult() {
  api('updateMatchResult', {matchId: val('score-match'), winner: val('s-winner')});
}

// --- PROFILE ---
function renderProfile(p) {
  document.getElementById('prof-name').innerText = p.Name;
  const pStats = DB.stats.filter(s => s.PlayerID == p.ID);
  
  let totalRuns = 0; let totalWkts = 0;
  const tbody = document.querySelector('#prof-history tbody');
  tbody.innerHTML = "";
  
  pStats.forEach(s => {
     totalRuns += Number(s.Runs); totalWkts += Number(s.Wickets);
     const m = DB.matches.find(x => x.MatchID == s.MatchID);
     if(m) {
       // Determine which team they played for (Saved in stat, or infer)
       const playedFor = s.Team || "Flex"; 
       const opponent = (playedFor === m.TeamA) ? m.TeamB : m.TeamA;
       
       tbody.innerHTML += `<tr>
         <td>${new Date(m.Date).toLocaleDateString()}</td>
         <td>${playedFor}</td>
         <td>vs ${opponent}</td>
         <td>${s.Runs}R / ${s.Wickets}W</td>
       </tr>`;
     }
  });
  
  document.getElementById('prof-runs').innerText = totalRuns;
  document.getElementById('prof-wkts').innerText = totalWkts;
}

// --- UTILS ---
function nav(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('btn-'+id);
  if(btn) btn.classList.add('active');
}

function val(id) { return document.getElementById(id).value; }

function toggleLogin() {
  const role = val('login-role');
  document.getElementById('admin-login-box').classList.toggle('hidden', role !== 'admin');
  document.getElementById('player-login-box').classList.toggle('hidden', role !== 'player');
}

function doAdminLogin() {
  if(val('admin-pass') === "9908") {
    nav('admin');
    document.getElementById('btn-admin').classList.remove('hidden');
    renderAdminLists();
  } else alert("Access Denied");
}

function doPlayerLogin() {
  const pid = val('login-pid');
  const pass = val('player-pass');
  const p = DB.players.find(x => x.ID == pid && x.Password == pass);
  if(p) {
    currentUser = p;
    document.getElementById('btn-profile').classList.remove('hidden');
    renderProfile(p);
    nav('profile');
  } else alert("Invalid Credentials");
}

function renderAdminLists() {
  const pl = document.getElementById('adm-player-list');
  pl.innerHTML = "";
  DB.players.forEach(p => {
    pl.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem;">
      <span>${p.Name}</span>
      <span style="color:red; cursor:pointer;" onclick="api('deletePlayer', {id:'${p.ID}'})">DELETE</span>
    </div>`;
  });
  
  const al = document.getElementById('adm-ann-list');
  al.innerHTML = "";
  DB.announcements.forEach(a => {
    al.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem;">
      <span>${a.Message}</span>
      <span style="color:red; cursor:pointer;" onclick="api('deleteAnnouncement', {id:'${a.ID}'})">DELETE</span>
    </div>`;
  });
}

function populateDropdowns() {
  const pOpts = DB.players.map(p => `<option value="${p.ID}">${p.Name}</option>`).join("");
  document.getElementById('login-pid').innerHTML = pOpts;
  document.getElementById('score-player').innerHTML = pOpts;
  
  const tOpts = DB.tournaments.map(t => `<option value="${t.ID}">${t.Name}</option>`).join("");
  document.getElementById('adm-tourn').innerHTML = tOpts;
  document.getElementById('f-tourn').innerHTML += tOpts;
  
  const mOpts = DB.matches.filter(m => m.Status !== "Completed").map(m => `<option value="${m.MatchID}">${m.TeamA} vs ${m.TeamB}</option>`).join("");
  document.getElementById('score-match').innerHTML = "<option>Select Match...</option>" + mOpts;
}
</script>
</body>
</html>
