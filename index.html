<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Pro Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --primary: #4f46e5; /* Indigo */
            --primary-dark: #3730a3;
            --text-main: #1e293b; /* Deep Slate */
            --text-muted: #64748b;
            --accent: #10b981; /* Emerald */
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: var(--text-main); 
            margin: 0; padding-bottom: 60px;
        }

        .hidden { display: none !important; }

        /* Navigation */
        .navbar { 
            background: var(--surface); border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 1000; padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .nav-links { display: flex; gap: 15px; }
        .nav-btn { cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); border: none; background: none; }
        .nav-btn.active { color: var(--primary); }

        /* Ticker */
        .ticker { background: var(--primary); color: white; padding: 8px 0; overflow: hidden; white-space: nowrap; }
        .ticker-inner { display: inline-block; animation: scroll 30s linear infinite; }
        @keyframes scroll { 100% { transform: translateX(-100%); } }

        /* Container & Cards */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { 
            background: var(--surface); border-radius: 16px; padding: 20px; 
            margin-bottom: 20px; border: 1px solid var(--border); box-shadow: var(--shadow);
        }
        h2 { font-size: 1.1rem; margin-top: 0; color: var(--text-main); display: flex; align-items: center; gap: 8px; }

        /* Components */
        .btn { 
            background: var(--primary); color: white; border: none; padding: 12px 20px; 
            border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border);
            border-radius: 10px; box-sizing: border-box; font-family: inherit;
        }

        /* Countdown Card */
        .hero { 
            background: linear-gradient(135deg, #4f46e5, #818cf8); color: white; 
            text-align: center; padding: 30px; border-radius: 20px;
        }
        #cd-timer { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 12px 10px; font-size: 0.9rem; border-bottom: 1px solid var(--border); }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; background: #f1f5f9; }

        /* Responsive Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div class="navbar">
    <div class="logo">CRICKET<span style="color:var(--text-muted)">PRO</span></div>
    <div class="nav-links">
        <button class="nav-btn active" onclick="showView('home')">Home</button>
        <button class="nav-btn" onclick="showView('rankings')">Stats</button>
        <button class="nav-btn" onclick="checkAuth()">Admin</button>
    </div>
</div>

<div class="ticker" id="ticker-box">
    <div class="ticker-inner" id="ticker-text">Welcome to the Tournament! Stay tuned for live updates.</div>
</div>

<div class="container">
    
    <!-- HOME VIEW -->
    <div id="v-home" class="view">
        <div class="hero card">
            <div id="next-match-label" style="opacity: 0.9; font-size: 0.9rem;">NEXT MATCH COUNTDOWN</div>
            <div id="cd-teams" style="font-weight: 700; font-size: 1.2rem; margin-top:5px;">Loading...</div>
            <div id="cd-timer">00:00:00</div>
            <div id="cd-date" style="font-size: 0.8rem; opacity: 0.8;"></div>
        </div>

        <div class="card">
            <h2>Recent Matches</h2>
            <div id="recent-matches"></div>
        </div>
    </div>

    <!-- RANKINGS VIEW -->
    <div id="v-rankings" class="view hidden">
        <div class="card">
            <h2>Leaderboards</h2>
            <div class="grid">
                <select id="filt-season" onchange="renderRankings()"><option value="All">All Seasons</option></select>
                <select id="filt-tourn" onchange="renderRankings()"><option value="All">All Tournaments</option></select>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-outline" onclick="setRankTab('bat')">Batting</button>
                <button class="btn btn-outline" onclick="setRankTab('bowl')">Bowling</button>
                <button class="btn btn-outline" onclick="setRankTab('team')">Teams</button>
            </div>

            <div id="rank-content" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="v-admin" class="view hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2>Admin Panel</h2>
                <button onclick="logout()" class="nav-btn">Logout</button>
            </div>
            
            <!-- Announcements -->
            <div style="border-top: 1px solid var(--border); padding-top:15px; margin-top:15px;">
                <h3>Announcements</h3>
                <input type="text" id="ann-msg" placeholder="Message">
                <button class="btn btn-outline" onclick="addAnn()">Broadcast</button>
            </div>

            <!-- Tournaments -->
            <div style="border-top: 1px solid var(--border); padding-top:15px; margin-top:15px;">
                <h3>Add Tournament</h3>
                <div class="grid">
                    <input type="text" id="trn-name" placeholder="Tournament Name">
                    <input type="text" id="trn-season" placeholder="Season (e.g. 2024)">
                </div>
                <button class="btn btn-outline" onclick="addTrn()">Create Tournament</button>
            </div>

            <!-- Players -->
            <div style="border-top: 1px solid var(--border); padding-top:15px; margin-top:15px;">
                <h3>Add Player</h3>
                <div class="grid">
                    <input type="text" id="ply-name" placeholder="Name">
                    <input type="password" id="ply-pass" placeholder="Password">
                </div>
                <button class="btn btn-outline" onclick="addPly()">Add Player</button>
            </div>

            <!-- Match Create -->
            <div style="border-top: 1px solid var(--border); padding-top:15px; margin-top:15px;">
                <h3>Schedule Match</h3>
                <select id="mat-trn"></select>
                <input type="text" id="mat-stage" placeholder="Stage (e.g. Semi Final 1)">
                <div class="grid">
                    <input type="text" id="mat-ta" placeholder="Team A">
                    <input type="text" id="mat-tb" placeholder="Team B">
                </div>
                <input type="datetime-local" id="mat-date">
                <button class="btn btn-outline" onclick="addMatch()">Schedule</button>
            </div>

            <!-- Scoring -->
            <div style="border-top: 1px solid var(--border); padding-top:15px; margin-top:15px;">
                <h3>Post Score</h3>
                <select id="score-match" onchange="loadMatchForm()"></select>
                <div id="score-form" class="hidden">
                    <div class="grid">
                        <select id="score-ply"></select>
                        <select id="score-team"></select>
                    </div>
                    <div class="grid">
                        <input type="number" id="score-runs" placeholder="Runs">
                        <input type="number" id="score-wkts" placeholder="Wickets">
                    </div>
                    <button class="btn" onclick="addStat()">+ Add Player Performance</button>
                    <hr>
                    <input type="text" id="score-winner" placeholder="Match Winner Team Name">
                    <button class="btn" style="background:var(--accent)" onclick="finalizeMatch()">Finalize Match</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbz8f8eKo4hMuqvXd2nTCbANMvgsH7ZM0pT88g0jVPV1upsiN96jnUN4joJHT_Rf67YT/exec"; 
    const PASS = "9908";
    let DB = {};
    let currentRankTab = 'bat';

    window.onload = () => loadData();

    async function loadData() {
        try {
            const res = await fetch(API + "?action=getAllData");
            DB = await res.json();
            render();
            document.getElementById('loader').classList.add('hidden');
        } catch (e) { alert("Data load failed. Check Console."); }
    }

    function render() {
        // Ticker
        if(DB.announcements.length > 0) {
            document.getElementById('ticker-text').innerText = DB.announcements.map(a => a.Message).join(" • ");
        }

        // Home View
        renderHome();
        
        // Populate Drops
        fillSelect('filt-season', [...new Set(DB.tournaments.map(t => t.Season))], true);
        fillSelect('filt-tourn', DB.tournaments.map(t => ({id: t.ID, name: t.Name})), true);
        fillSelect('mat-trn', DB.tournaments.map(t => ({id: t.ID, name: t.Name})));
        fillSelect('score-match', DB.matches.filter(m => m.Status !== 'Completed').map(m => ({id: m.MatchID, name: `${m.TeamA} vs ${m.TeamB}`})), false, "Select Match");
        fillSelect('score-ply', DB.players.map(p => ({id: p.ID, name: p.Name})));

        renderRankings();
    }

    function renderHome() {
        const now = new Date();
        const future = DB.matches
            .filter(m => new Date(m.Date) > now)
            .sort((a,b) => new Date(a.Date) - new Date(b.Date));

        if(future.length > 0) {
            const next = future[0];
            document.getElementById('cd-teams').innerText = `${next.TeamA} vs ${next.TeamB}`;
            document.getElementById('cd-date').innerText = new Date(next.Date).toLocaleString();
            startCountdown(next.Date);
        }

        const recent = document.getElementById('recent-matches');
        recent.innerHTML = DB.matches.slice(-5).reverse().map(m => `
            <div style="padding:10px; border-bottom:1px solid #eee;">
                <div style="font-size:0.7rem; color:var(--text-muted)">${m.Stage} • ${new Date(m.Date).toLocaleDateString()}</div>
                <div style="display:flex; justify-content:space-between; font-weight:600;">
                    <span>${m.TeamA} vs ${m.TeamB}</span>
                    <span style="color:var(--accent)">${m.Winner ? m.Winner + ' won' : 'Scheduled'}</span>
                </div>
            </div>
        `).join('');
    }

    function renderRankings() {
        const sFilter = document.getElementById('filt-season').value;
        const tFilter = document.getElementById('filt-tourn').value;
        const content = document.getElementById('rank-content');

        // Filter valid matches
        let validMatches = DB.matches;
        if(tFilter !== 'All') validMatches = validMatches.filter(m => m.TournamentID == tFilter);
        if(sFilter !== 'All') {
            const allowedTrns = DB.tournaments.filter(t => t.Season == sFilter).map(t => t.ID);
            validMatches = validMatches.filter(m => allowedTrns.includes(m.TournamentID));
        }
        const matchIds = validMatches.map(m => m.MatchID);

        if(currentRankTab === 'bat' || currentRankTab === 'bowl') {
            const stats = {};
            DB.stats.filter(s => matchIds.includes(s.MatchID)).forEach(s => {
                if(!stats[s.PlayerID]) stats[s.PlayerID] = { name: (DB.players.find(p => p.ID == s.PlayerID)?.Name || 'Unknown'), r: 0, w: 0 };
                stats[s.PlayerID].r += parseInt(s.Runs || 0);
                stats[s.PlayerID].w += parseInt(s.Wickets || 0);
            });

            const sorted = Object.values(stats).sort((a,b) => currentRankTab === 'bat' ? b.r - a.r : b.w - a.w);
            content.innerHTML = `<table><tr><th>Player</th><th>${currentRankTab === 'bat' ? 'Runs' : 'Wickets'}</th></tr>
                ${sorted.map(p => `<tr><td>${p.name}</td><td>${currentRankTab === 'bat' ? p.r : p.w}</td></tr>`).join('')}</table>`;
        } else {
            const teams = {};
            validMatches.filter(m => m.Status === 'Completed').forEach(m => {
                if(!teams[m.TeamA]) teams[m.TeamA] = {w:0};
                if(!teams[m.TeamB]) teams[m.TeamB] = {w:0};
                if(m.Winner) teams[m.Winner].w++;
            });
            const sorted = Object.keys(teams).sort((a,b) => teams[b].w - teams[a].w);
            content.innerHTML = `<table><tr><th>Team</th><th>Wins</th></tr>
                ${sorted.map(t => `<tr><td>${t}</td><td>${teams[t].w}</td></tr>`).join('')}</table>`;
        }
    }

    // Handlers
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById('v-' + id).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    }

    function setRankTab(t) { currentRankTab = t; renderRankings(); }

    function startCountdown(date) {
        const target = new Date(date).getTime();
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const dist = target - now;
            if(dist < 0) { clearInterval(timer); document.getElementById('cd-timer').innerText = "LIVE"; return; }
            const h = Math.floor(dist / 3600000);
            const m = Math.floor((dist % 3600000) / 60000);
            const s = Math.floor((dist % 60000) / 1000);
            document.getElementById('cd-timer').innerText = `${h}h ${m}m ${s}s`;
        }, 1000);
    }

    // Admin Actions
    async function api(action, data) {
        document.getElementById('loader').classList.remove('hidden');
        data.action = action;
        data.password = PASS;
        await fetch(API, { method: 'POST', body: JSON.stringify(data) });
        loadData();
    }

    function addAnn() { api('addAnn', { id: 'AN'+Date.now(), message: val('ann-msg'), priority: 1, date: new Date() }); }
    function addTrn() { api('addTrn', { id: 'TR'+Date.now(), name: val('trn-name'), season: val('trn-season') }); }
    function addPly() { api('addPlayer', { id: 'P'+Date.now(), name: val('ply-name'), pass: val('ply-pass'), role: 'Player', team: 'TBD' }); }
    function addMatch() { 
        api('addMatch', { 
            id: 'M'+Date.now(), trnId: val('mat-trn'), stage: val('mat-stage'), 
            teamA: val('mat-ta'), teamB: val('mat-tb'), date: val('mat-date') 
        }); 
    }
    
    function loadMatchForm() {
        const mid = val('score-match');
        const match = DB.matches.find(m => m.MatchID == mid);
        if(!match) return;
        document.getElementById('score-form').classList.remove('hidden');
        fillSelect('score-team', [match.TeamA, match.TeamB]);
    }

    function addStat() {
        api('addStat', {
            id: 'ST'+Date.now(), matchId: val('score-match'), playerId: val('score-ply'),
            team: val('score-team'), runs: val('score-runs'), wickets: val('score-wkts')
        });
    }

    function finalizeMatch() {
        api('finalizeMatch', { matchId: val('score-match'), winner: val('score-winner') });
    }

    // Utils
    function val(id) { return document.getElementById(id).value; }
    function fillSelect(id, list, all = false, defText = "") {
        const el = document.getElementById(id);
        el.innerHTML = all ? '<option value="All">All</option>' : (defText ? `<option value="">${defText}</option>` : '');
        list.forEach(item => {
            const val = typeof item === 'object' ? item.id : item;
            const text = typeof item === 'object' ? item.name : item;
            el.innerHTML += `<option value="${val}">${text}</option>`;
        });
    }
    function checkAuth() {
        const p = prompt("Admin PIN:");
        if(p === PASS) showView('admin');
        else alert("Wrong PIN");
    }
    function logout() { showView('home'); }
</script>
</body>
</html>
